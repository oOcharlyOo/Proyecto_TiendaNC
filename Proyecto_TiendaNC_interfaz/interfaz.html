<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Punto de Venta - VENTA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="resources/style/estilos.css">
</head>

<body class="main-page-body">
    <div id="navbar-placeholder"></div>

    <div class="main-container flex-col md:flex-row p-2">
                    <div id="ticketPanel" class="flex-grow flex flex-col rounded-lg shadow-xl overflow-hidden">            <div class="p-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800" style="color: #0357b8;">VENTA - Ticket <span id="ticketIdDisplay">Cargando...</span>
                </h2>
                <div class="flex flex-col sm:flex-row mt-3 space-y-2 sm:space-y-0 sm:space-x-2">
                    <div class="relative flex-grow">
                        <label for="codigoProducto" class="block text-sm font-medium text-primary self-center" style="color: rgb(31, 26, 26);">Código o Nombre del Producto:</label>
                        <input type="text" id="codigoProducto" placeholder="Escanear código o escribir nombre..."
                            class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary input-focus-primary"
                            disabled>
                        <div id="searchResultsContainer" class="absolute z-10 w-full border border-gray-300 rounded-b-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto">
                            <!-- Los resultados de la búsqueda se inyectarán aquí -->
                        </div>  
                    </div>
                    <button id="agregarProductoBtn"
                        class="btn-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-dark transition duration-150 shadow-md self-end"
                        disabled>ENTER - Agregar por Código</button>
                </div>
            </div>
            <div class="flex-grow flex flex-col overflow-hidden">
                <div id="tablaEditada" class="flex-grow overflow-y-auto border-t border-gray-300">
                    <div class="overflow-x-auto">
                        <table id="ticketTable" class="w-full text-left ticket-table text-sm">
                            <thead>
                                <tr>
                                    <th class="p-2 w-[15%]">Código</th>
                                    <th class="p-2 w-[40%]">Descripción</th>
                                    <th class="p-2 w-[15%] text-right">Precio</th>
                                    <th class="p-2 w-[15%] text-center">Cantidad</th>
                                    <th class="p-2 w-[15%] text-right">Importe</th>
                                </tr>
                            </thead>
                            <tbody id="ticketItems"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
            <div class="w-full md:w-1/4 min-w-[280px] flex flex-col panel-transparent rounded-lg shadow-xl p-4">            
                <h3 class="text-lg font-bold text-gray-800 mb-4">Resumen de Venta</h3>
            <div class="flex-grow">
                <div class="summary-row"><span>Subtotal:</span><span id="subtotalDisplay">$0.00</span></div>
                <div class="summary-total mt-4 border-t-2 border-gray-200"><span>TOTAL:</span><span id="totalDisplay"
                        class="text-primary">$0.00</span></div>
            </div>
            <div class="mt-4 space-y-3">
                <button id="cobrarEfectivoBtn"
                    class="w-full bg-rose-600 text-white font-semibold py-3 rounded-lg hover:bg-rose-700 transition duration-150 shadow-md">F12
                    - Cobrar (Efectivo)
                </button>
                <button id="verHistorialBtn"
                    class="w-full btn-primary text-white font-semibold py-3 rounded-lg hover:bg-primary-dark transition duration-150 shadow-md">
                    Historial de Ventas
                </button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Cobro en Efectivo</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Total a Pagar:</p>
                    <p id="modalTotalAmount" class="text-3xl font-bold text-primary">$0.00</p>
                    <div class="mt-4">
                        <label for="amountPaid" class="block text-sm font-medium text-gray-700">Monto Recibido</label>
                        <input type="number" id="amountPaid"
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                            placeholder="0.00">
                    </div>
                    <div class="mt-4">
                        <p class="text-sm text-gray-500">Cambio:</p>
                        <p id="changeAmount" class="text-2xl font-bold text-income-color">$0.00</p>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmPaymentBtn"
                        class="px-4 py-2 btn-primary text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary">
                        Confirmar Pago
                    </button>
                    <button id="confirmPaymentSpeiBtn"
                        class="mt-2 px-4 py-2 btn-primary text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary">
                        Confirmar Pago Transferencia
                    </button>
                    <button id="cancelPaymentBtn"
                        class="mt-2 px-4 py-2 btn-danger text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-danger-dark focus:outline-none focus:ring-2 focus:ring-danger">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Historial de Ventas -->
    <div id="historialVentasModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
        <div class="historial-modal-content relative">
            <h3 class="text-xl leading-6 font-bold text-gray-900 mb-4">Historial de Ventas del Día</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-left">
                <div class="bg-gray-100 p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Cobro Total del Día</p>
                    <p id="historialCobroTotal" class="text-2xl font-bold text-income-color">$0.00</p>
                </div>
                <div class="bg-gray-100 p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Ganancia Total del Día</p>
                    <p id="historialGananciaTotal" class="text-2xl font-bold text-profit-color">$0.00</p>
                </div>
            </div>

            <div class="max-h-96 overflow-y-auto overflow-x-auto">
                <table class="historial-table">
                    <thead>
                        <tr>
                            <th>ID Venta</th>
                            <th>Monto</th>
                            <th>Método Pago</th>
                            <th>Estatus</th>
                            <th>Fecha</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="historialVentasBody">
                        <!-- Las filas de ventas se insertarán aquí -->
                    </tbody>
                </table>
            </div>

            <div class="mt-6 text-right">
                <button id="cerrarHistorialModalBtn" class="btn-secondary text-white px-4 py-2 rounded-md hover:bg-secondary-dark">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <script>
        const API_BASE_URL = 'http://192.168.0.248:8080';
        const activeUser = JSON.parse(sessionStorage.getItem('activeUser'));

        // Only initialize page logic if a user is logged in.
        // The nav.js script handles redirection for unauthenticated users.
        if (activeUser) {
            const ID_USUARIO = activeUser.idUsuario;
            let activeSaleId = null;
            let ticket = [];

            // Gramaje Calculator Modal DOM elements declared here, inside activeUser check
            let gramajeCalculatorModal;
            let calcProductName;
            let calcProductId;
            let calcProductPricePerKilo; // Original price_venta from product
            let calcProductStock; // Original stock from product

            let gramajeInput; // New ID for Grams input
            let precioTotal; // New ID for Total Price display (div)
            let precioBase; // New ID for Price per Kilo input
            let calcResetBtn; // New ID for Reset Button

            let calcAddToCartBtn;
            let calcCancelBtn;


            // Moved function definitions outside DOMContentLoaded for broader scope if needed
            function openGramajeCalculator(product) {
                if (!gramajeCalculatorModal) { // Check if elements are initialized
                    console.error("Gramaje calculator modal elements not initialized.");
                    return;
                }
                calcProductName.value = product.nombre;
                calcProductId.value = product.idProducto;
                calcProductPricePerKilo.value = product.precio_venta; // Hidden input for original product price_venta
                calcProductStock.value = product.stock; // Hidden input for stock in grams

                // Populate new visible elements
                precioBase.value = product.precio_venta; // Set initial price per kilo
                gramajeInput.value = ''; // Clear gramaje input
                precioTotal.value = ''; // Changed from .textContent to .value

                gramajeCalculatorModal.classList.remove('hidden');
                gramajeInput.focus(); // Focus on the main gramaje input
            }

            function closeGramajeCalculator() {
                if (gramajeCalculatorModal) { // Check if element is initialized
                    gramajeCalculatorModal.classList.add('hidden');
                }
            }

            // All other DOM-related variables and event listeners should be inside DOMContentLoaded
            document.addEventListener('DOMContentLoaded', () => { 
                const codigoProductoInput = document.getElementById('codigoProducto');
                const ventaMayoreoCheckbox = document.getElementById('ventaMayoreoCheckbox'); // NEW
                const agregarProductoBtn = document.getElementById('agregarProductoBtn');
                const ticketItemsTableBody = document.getElementById('ticketItems');
                const ticketIdDisplay = document.getElementById('ticketIdDisplay');
                const subtotalDisplay = document.getElementById('subtotalDisplay');
                const totalDisplay = document.getElementById('totalDisplay');
                const cobrarEfectivoBtn = document.getElementById('cobrarEfectivoBtn');
                
                const searchResultsContainer = document.getElementById('searchResultsContainer');
                let debounceTimer;

                const paymentModal = document.getElementById('paymentModal');
                const modalTotalAmount = document.getElementById('modalTotalAmount');
                const amountPaid = document.getElementById('amountPaid');
                const changeAmount = document.getElementById('changeAmount');
                const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
                const confirmPaymentSpeiBtn = document.getElementById('confirmPaymentSpeiBtn');
                const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');

                const ticketPanel = document.getElementById('ticketPanel'); // Nuevo: Referencia al panel principal del ticket

                // Initialize Gramaje Calculator Modal DOM elements inside DOMContentLoaded
                gramajeCalculatorModal = document.getElementById('gramajeCalculatorModal');
                calcProductName = document.getElementById('calcProductName');
                calcProductId = document.getElementById('calcProductId');
                calcProductPricePerKilo = document.getElementById('calcProductPricePerKilo'); // Hidden input for original product price_venta
                calcProductStock = document.getElementById('calcProductStock');

                // New visible elements
                gramajeInput = document.getElementById('gramajeInput');
                precioTotal = document.getElementById('precioTotal'); // This is a div, so .textContent
                precioBase = document.getElementById('precioBase'); // This is an input for the user to adjust price per kilo

                calcAddToCartBtn = document.getElementById('calcAddToCartBtn');
                calcCancelBtn = document.getElementById('calcCancelBtn');
                calcResetBtn = document.getElementById('calcResetBtn');
            async function fetchApi(endpoint, method = 'GET', data = null) {
                let url = `${API_BASE_URL}${endpoint}`;
                const options = { method, headers: { 'Content-Type': 'application/json' } };

                // Para 'completarVenta', todos los datos se convierten en parámetros de consulta en la URL.
                if (endpoint.includes('/ventas/completarVenta/') && data) {
                    const params = new URLSearchParams();
                    for (const key in data) {
                        if (data[key] !== undefined) {
                            params.append(key, data[key]);
                        }
                    }
                    if (params.toString()) {
                        url += `?${params.toString()}`;
                    }
                } 
                // Para todas las demás solicitudes, los datos van en el cuerpo.
                else if (data) {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(url, options);
                    // Si el método es PUT para cancelarVenta, puede que no haya cuerpo en la respuesta
                    if (method === 'PUT' && endpoint.includes('/ventas/cancelarVenta/')) {
                        if (!response.ok) {
                            // Intenta obtener un mensaje de error si lo hay
                             const errorText = await response.text();
                             try {
                                const errorJson = JSON.parse(errorText);
                                throw new Error(errorJson.mensaje || `Error HTTP: ${response.status}`);
                             } catch(e) {
                                throw new Error(errorText || `Error HTTP: ${response.status}`);
                             }
                        }
                        return; // No se espera cuerpo en la respuesta de cancelar
                    }


                    let responseData = {};
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        responseData = await response.json();
                    }
                    if (!response.ok) {
                        const errorMessage = (responseData && (responseData.mensaje || responseData.error)) || `Error HTTP: ${response.status}`;
                        throw new Error(errorMessage);
                    }
                    
                    if (responseData.hasOwnProperty('datos')) {
                       return responseData.datos;
                    }
                    return responseData;
                } catch (error) {
                    console.error("Error en la llamada a la API:", error);
                    throw error;
                }
            }

            function alertUser(message, type = 'info') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 ${type === 'success' ? 'bg-primary' : 'bg-danger'}`;
                alertDiv.textContent = message;
                document.body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 3000);
            }

            function updateTotals() {
                const total = ticket.reduce((sum, item) => sum + (item.precioUnitarioVenta * item.cantidad), 0);
                subtotalDisplay.textContent = totalDisplay.textContent = `$${total.toFixed(2)}`;
            }

            function renderTicket() {
                // Update table header for new column
                const tableHeader = document.querySelector('#ticketTable thead tr');
                tableHeader.innerHTML = `
                    <th class="p-2 w-[8%]">Código</th>
                    <th class="p-2 w-[35%] whitespace-normal break-words">Descripción</th>
                    <th class="p-2 w-[10%] text-right">Precio</th>
                    <th class="p-2 w-[8%] text-center">Mayoreo</th>
                    <th class="p-2 w-[12%] text-center">Cantidad</th>
                    <th class="p-2 w-[15%] text-right">Importe</th>
                    <th class="p-2 w-[12%] text-center">Eliminar</th> <!-- New column -->
                `;

                ticketItemsTableBody.innerHTML = '';
                if (ticket.length === 0) {
                    ticketItemsTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">No hay productos</td></tr>`;
                    ticketPanel.classList.remove('has-products-bg');
                } else {
                    ticket.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.className = 'border-b encabezado-zelda-text';
                        const hasValidMayoreo = item.Producto.precio_mayoreo && item.Producto.precio_mayoreo > 0;
                        row.innerHTML = `
                            <td class="p-2">${item.idProducto}</td>
                            <td class="p-2 whitespace-normal break-words">${item.nombreProducto || 'Cargando...'}</td>
                            <td class="p-2 text-right">$${(item.precioUnitarioVenta || 0).toFixed(2)}</td>
                            <td class="p-2 text-center">
                                <input type="checkbox" class="mayoreo-checkbox h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" data-index="${index}" ${item.isMayoreo ? 'checked' : ''} ${hasValidMayoreo ? '' : 'disabled'}>
                            </td>
                            <td class="p-2 text-center">
                                <button class="qty-btn btn-qty-minus" data-index="${index}">-</button>
                                <span class="mx-1 sm:mx-2">${item.cantidad}</span>
                                <button class="qty-btn btn-qty-plus" data-index="${index}">+</button>
                            </td>
                            <td class="p-2 text-right importe-green">$${((item.precioUnitarioVenta || 0) * item.cantidad).toFixed(2)}</td>
                            <td class="p-2 text-center"> <!-- New column -->
                                <button class="btn-delete-item p-1 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" data-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-danger" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        `;
                        ticketItemsTableBody.appendChild(row);
                    });
                    ticketPanel.classList.add('has-products-bg');
                }
                updateTotals();
            }

            async function updateQuantity(index, change) {
                const item = ticket[index];
                const newQuantity = item.cantidad + change;
                if (change > 0 && newQuantity > item.existence) {
                    alertUser('No se puede exceder la cantidad en inventario.', 'error');
                    return;
                }
                if (newQuantity < 1) {
                    await fetchApi(`/ventasDetalle/eliminarVentaDetalle/${item.idVentaDetalle}`, 'DELETE');
                    ticket.splice(index, 1);
                } else {
                    const updatedItem = { ...item, cantidad: newQuantity };
                    await fetchApi(`/ventasDetalle/actualizarVentaDetalle/${item.idVentaDetalle}`, 'PUT', updatedItem);
                    ticket[index] = updatedItem;
                }
                renderTicket();
            }

            async function addProduct(code) {
                if (!code) return;
                codigoProductoInput.disabled = true;
                agregarProductoBtn.textContent = 'Buscando...';
                try {
                    const productData = await fetchApi(`/productos/buscarProductoPorId/${String(code).trim()}`);
                    if (!productData || !productData.idProducto) throw new Error("Producto no encontrado.");
                    
                    if (ticket.find(item => item.idProducto === productData.idProducto)) {
                        if ((ticket.find(item => item.idProducto === productData.idProducto).cantidad + 1) > productData.stock) {
                           alertUser(`Stock insuficiente para "${productData.nombre}".`, 'error');
                           return;
                        }
                    } else {
                        if (!productData.stock || productData.stock <= 0) {
                            alertUser(`El producto "${productData.nombre}" no tiene existencias.`, 'error');
                            return;
                        }
                    }

                    if (productData.is_gramaje) {
                        openGramajeCalculator(productData);
                        return;
                    }

                    if (!activeSaleId) {
                        await createNewSale();
                    }

                    if (!activeSaleId) throw new Error("No se pudo crear una nueva venta.");

                    const existingItemIndex = ticket.findIndex(item => item.idProducto === productData.idProducto);
                    if (existingItemIndex !== -1) {
                        await updateQuantity(existingItemIndex, 1);
                    } else {
                        const ventaData = await fetchApi(`/ventas/obtenerVentaPorId/${activeSaleId}`);
                        const detailPayload = {
                            cantidad: 1,
                            precioUnitarioVenta: productData.precio_venta, // Default to retail
                            Venta: ventaData,
                            Producto: productData,
                            tipoPrecioAplicado: "VENTA" // Default to VENTA
                        };
                        const newDetail = await fetchApi('/ventasDetalle/agregarVentaDetalle', 'POST', detailPayload);
                        ticket.push({
                            idProducto: productData.idProducto,
                            nombreProducto: productData.nombre,
                            cantidad: 1,
                            precioUnitarioVenta: productData.precio_venta, // Default to retail
                            existence: productData.stock,
                            idVentaDetalle: newDetail.idVentaDetalle,
                            Venta: ventaData,
                            Producto: productData,
                            isMayoreo: false // Add flag
                        });
                        renderTicket();
                    }
                } catch (error) {
                    alertUser(`Error: ${error.message}`, 'error');
                } finally {
                    codigoProductoInput.value = '';
                    codigoProductoInput.disabled = false;
                    agregarProductoBtn.textContent = 'ENTER - Agregar por Código';
                    codigoProductoInput.focus();
                }
            }

            async function createNewSale() {
                try {
                    const newSaleData = { usuario: { idUsuario: ID_USUARIO }, montoTotal: 0, estatus: 'P' };
                    const createdSale = await fetchApi('/ventas/agregarVenta', 'POST', newSaleData);
                    if (!createdSale || !createdSale.idVenta) throw new Error("La API no devolvió un ID de venta válido.");
                    activeSaleId = createdSale.idVenta;
                    ticket = [];
                    ticketIdDisplay.textContent = createdSale.numeroTicket;
                    renderTicket();
                    alertUser(`Nueva venta #${createdSale.numeroTicket} iniciada.`, 'success');
                } catch (error) {
                    ticketIdDisplay.textContent = 'ERROR';
                    alertUser(`Error al crear nueva venta: ${error.message}`, 'error');
                    throw error;
                }
            }

            async function initializeSale() {
                ticketIdDisplay.textContent = 'Buscando...';
                try {
                    const allSales = await fetchApi('/ventas/obetenerVentas');
                    const pendingSale = Array.isArray(allSales) ? allSales.find(v => v.estatus === 'P' && v.usuario?.idUsuario === ID_USUARIO) : null;
                    if (pendingSale) {
                        activeSaleId = pendingSale.idVenta;
                        ticketIdDisplay.textContent = pendingSale.numeroTicket;
                        const allDetails = await fetchApi('/ventasDetalle/obtenerTodosLosVentasDetalles');
                        ticket = Array.isArray(allDetails) ? allDetails.filter(d => d.Venta.idVenta === activeSaleId).map(detail => ({
                            idProducto: detail.Producto.idProducto,
                            nombreProducto: detail.Producto.nombre,
                            cantidad: detail.cantidad,
                            precioUnitarioVenta: detail.precioUnitarioVenta,
                            existence: detail.Producto.stock,
                            idVentaDetalle: detail.idVentaDetalle,
                            Venta: detail.Venta,
                            Producto: detail.Producto,
                            isMayoreo: (detail.Producto.precio_mayoreo && detail.precioUnitarioVenta === detail.Producto.precio_mayoreo) // Infer state
                        })) : [];
                        renderTicket();
                    } else {
                        activeSaleId = null;
                        ticket = [];
                        ticketIdDisplay.textContent = 'Pendiente';
                        renderTicket();
                    }
                } catch (error) {
                    alertUser(`Error al inicializar: ${error.message}`, 'error');
                    activeSaleId = null; ticket = []; ticketIdDisplay.textContent = 'ERROR'; renderTicket();
                } finally {
                    codigoProductoInput.disabled = false;
                    agregarProductoBtn.disabled = false;
                    codigoProductoInput.focus();
                }
            }

            function openPaymentModal() {
                if (!activeSaleId || ticket.length === 0) {
                    alertUser('No hay productos para cobrar.', 'error');
                    return;
                }
                const total = ticket.reduce((sum, item) => sum + (item.precioUnitarioVenta * item.cantidad), 0);
                modalTotalAmount.textContent = `$${total.toFixed(2)}`;
                amountPaid.value = '';
                changeAmount.textContent = '$0.00';
                paymentModal.classList.remove('hidden');
                amountPaid.focus();
            }

            function closePaymentModal() {
                paymentModal.classList.add('hidden');
            }

            // New Gramaje Calculator Functions
            function updateCalculatorDisplay(source) {
                let grams = parseFloat(gramajeInput.value) || 0;
                let totalPrice = parseFloat(precioTotal.value) || 0;
                const pricePerKilo = parseFloat(precioBase.value) || 0;

                if (source === 'grams') {
                    if (!isNaN(grams) && !isNaN(pricePerKilo) && grams >= 0) {
                        totalPrice = (grams / 1000) * pricePerKilo;
                        precioTotal.value = totalPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    } else {
                        precioTotal.value = '';
                    }
                } else if (source === 'totalPrice') {
                    if (!isNaN(totalPrice) && !isNaN(pricePerKilo) && pricePerKilo > 0 && totalPrice >= 0) {
                        grams = (totalPrice / pricePerKilo) * 1000;
                        gramajeInput.value = grams.toFixed(0);
                    } else {
                        gramajeInput.value = '';
                    }
                }
            }

            function setGramaje(grams) {
                gramajeInput.value = grams;
                updateCalculatorDisplay('grams'); // Corrected function call
            }

            function resetGramajeCalculator() { // Renamed from reset() to avoid conflict
                gramajeInput.value = '';
                precioTotal.value = ''; // Changed from .textContent to .value
                precioBase.value = calcProductPricePerKilo.value; // Reset to product's original price per kilo
                gramajeInput.focus();
                updateCalculatorDisplay('grams');
            }

            function calculateChange() {
                const total = parseFloat(modalTotalAmount.textContent.replace('$', ''));
                const paid = parseFloat(amountPaid.value) || 0;
                const change = paid - total;
                changeAmount.textContent = `$${change < 0 ? '0.00' : change.toFixed(2)}`;
            }

            async function handlePayment() {
                const total = parseFloat(modalTotalAmount.textContent.replace('$', ''));
                const paid = parseFloat(amountPaid.value) || 0;
                if (paid < total) {
                    alertUser('El monto pagado es menor al total.', 'error');
                    return;
                }
                await completeSale('Efectivo');
                closePaymentModal();
            }

            async function handleTransferPayment() {
                if (!activeSaleId || ticket.length === 0) return;
                try {
                    const montoTotal = ticket.reduce((sum, item) => sum + (item.precioUnitarioVenta * item.cantidad), 0);
                    const payload = {
                        montoTotal: montoTotal,
                        metodoPago: 'TRANSFERENCIA'
                    };
                    await fetchApi(`/ventas/completarVenta/${activeSaleId}`, 'PUT', payload);
                    alertUser(`Venta #${activeSaleId} completada con Transferencia.`, 'success');
                    await initializeSale();
                } catch (error) {
                    alertUser(`Error al completar la venta por transferencia: ${error.message}`, 'error');
                } finally {
                    closePaymentModal();
                }
            }

            async function completeSale(paymentMethod) {
                if (!activeSaleId || ticket.length === 0) return;
                try {
                    const montoTotal = ticket.reduce((sum, item) => sum + (item.precioUnitarioVenta * item.cantidad), 0);
                    // Eliminar tipoVenta del payload, ya que se gestiona por producto individual
                    await fetchApi(`/ventas/completarVenta/${activeSaleId}`, 'PUT', { montoTotal }); 
                    alertUser(`Venta #${activeSaleId} completada con ${paymentMethod}.`, 'success');
                    await initializeSale();
                } catch (error) {
                    alertUser(`Error al completar la venta: ${error.message}`, 'error');
                }
            }
            
            function renderSearchResults(products) {
                searchResultsContainer.innerHTML = '';
                if (!products || products.length === 0) {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                products.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    
                    let pricesHtml = `<p class="font-bold text-primary">$${(product.precio_venta || 0).toFixed(2)}</p>`;
                    if (product.precio_mayoreo && product.precio_mayoreo > 0) {
                        pricesHtml += `<p class="text-sm text-gray-500">Mayoreo: $${(product.precio_mayoreo || 0).toFixed(2)}</p>`;
                    }

                    item.innerHTML = `
                        <div>
                            <p class="font-semibold">${product.nombre}</p>
                            <p class="text-sm text-gray-500">Stock: ${product.stock}</p>
                        </div>
                        <div>${pricesHtml}</div>
                    `;
                    item.addEventListener('click', () => {
                        searchResultsContainer.classList.add('hidden');
                        codigoProductoInput.value = '';
                        addProduct(product.idProducto);
                    });
                    searchResultsContainer.appendChild(item);
                });
                searchResultsContainer.classList.remove('hidden');
            }

            async function searchProductsByName(query) {
                if(isNaN(query)){
                    try {
                        const results = await fetchApi(`/productos/buscar?nombre=${query}`);
                        renderSearchResults(results);
                    } catch (error) {
                        console.error('Error en búsqueda por nombre:', error);
                        searchResultsContainer.classList.add('hidden');
                    }
                } else {
                    searchResultsContainer.classList.add('hidden');
                }
            }

            function handleMayoreoToggle(e) {
                if (e.target.classList.contains('mayoreo-checkbox')) {
                    const index = parseInt(e.target.dataset.index);
                    const item = ticket[index];
                    const isChecked = e.target.checked;
                    
                    let newPrecio;
                    let newIsMayoreo;

                    if (isChecked) {
                        if (item.Producto.precio_mayoreo === null || item.Producto.precio_mayoreo === undefined || item.Producto.precio_mayoreo <= 0) {
                            alertUser(`El producto "${item.nombreProducto}" no tiene un precio por mayoreo válido.`, 'error');
                            e.target.checked = false; // Revert checkbox state
                            return;
                        }
                        newPrecio = item.Producto.precio_mayoreo;
                        newIsMayoreo = true;
                    } else {
                        newPrecio = item.Producto.precio_venta;
                        newIsMayoreo = false;
                    }
                    
                    const updatedItem = {
                        ...item,
                        precioUnitarioVenta: newPrecio,
                        isMayoreo: newIsMayoreo,
                        tipoPrecioAplicado: newIsMayoreo ? "MAYOREO" : "VENTA"
                    };
                    fetchApi(`/ventasDetalle/actualizarVentaDetalle/${item.idVentaDetalle}`, 'PUT', updatedItem)
                        .then(() => {
                            ticket[index] = updatedItem; // Update local ticket state
                            renderTicket();
                        })
                        .catch(err => {
                            alertUser(`Error al actualizar precio: ${err.message}`, 'error');
                            e.target.checked = !isChecked; // Revert checkbox state on API error
                            // Revert local state to match UI
                            item.precioUnitarioVenta = isChecked ? item.Producto.precio_venta : item.Producto.precio_mayoreo;
                            item.isMayoreo = !isChecked;
                            renderTicket(); // Re-render to ensure UI reflects correct state
                        }); 
                }
            }

            codigoProductoInput.addEventListener('input', e => {
                clearTimeout(debounceTimer);
                const query = e.target.value.trim();
                if (query.length < 2) {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                debounceTimer = setTimeout(() => {
                    searchProductsByName(query);
                }, 300);
            });

            document.addEventListener('click', (e) => {
                if (!searchResultsContainer.contains(e.target) && e.target !== codigoProductoInput) {
                    searchResultsContainer.classList.add('hidden');
                }
            });

            codigoProductoInput.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addProduct(e.target.value);
                    searchResultsContainer.classList.add('hidden');
                }
            });
            agregarProductoBtn.addEventListener('click', () => addProduct(codigoProductoInput.value));
            
            cobrarEfectivoBtn.addEventListener('click', openPaymentModal);
            cancelPaymentBtn.addEventListener('click', closePaymentModal);
            confirmPaymentBtn.addEventListener('click', handlePayment);
            confirmPaymentSpeiBtn.addEventListener('click', handleTransferPayment);
            amountPaid.addEventListener('input', calculateChange);
            ticketItemsTableBody.addEventListener('click', async e => {
                const target = e.target;
                if (target.classList.contains('btn-qty-plus')) await updateQuantity(target.dataset.index, 1);
                else if (target.classList.contains('btn-qty-minus')) await updateQuantity(target.dataset.index, -1);
                else if (target.classList.contains('mayoreo-checkbox')) handleMayoreoToggle(e);
                else if (target.closest('.btn-delete-item')) { // New condition for delete button
                    const index = target.closest('.btn-delete-item').dataset.index;
                    await removeProductFromTicket(index);
                }
            });
            document.addEventListener('keydown', e => {
                if (e.key === 'F12') { e.preventDefault(); openPaymentModal(); }
            });



            // --- Lógica para la Modal de Historial de Ventas ---
            const historialModal = document.getElementById('historialVentasModal');
            const verHistorialBtn = document.getElementById('verHistorialBtn');
            const cerrarHistorialModalBtn = document.getElementById('cerrarHistorialModalBtn');
            const historialVentasBody = document.getElementById('historialVentasBody');
            const historialCobroTotalEl = document.getElementById('historialCobroTotal');
            const historialGananciaTotalEl = document.getElementById('historialGananciaTotal');

            function getTodayDate() {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            async function cargarHistorialVentas() {
                const today = getTodayDate();
                historialVentasBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Cargando...</td></tr>';

                try {
                    const data = await fetchApi(`/ventas/obtenerVentaPorDia/${today}`);
                    
                    historialCobroTotalEl.textContent = `$${(data.cobroTotal || 0).toFixed(2)}`;
                    historialGananciaTotalEl.textContent = `$${(data.gananciaTotal || 0).toFixed(2)}`;

                    if (data.ventas && data.ventas.length > 0) {
                        historialVentasBody.innerHTML = '';
                        data.ventas.forEach(venta => {
                            const row = document.createElement('tr');
                            
                            // Determine status text and class based on new definitions
                            let statusText;
                            let statusClass;
                            if (venta.estatus === 'F') {
                                statusText = 'Finalizada';
                                statusClass = 'bg-green-200 text-green-800';
                            } else if (venta.estatus === 'C') {
                                statusText = 'Completada';
                                statusClass = 'bg-blue-200 text-blue-800'; // Using blue for 'Completada'
                            } else if (venta.estatus === 'I') {
                                statusText = 'Inactiva/Cancelada';
                                statusClass = 'bg-red-200 text-danger';
                            } else {
                                statusText = venta.estatus; // Fallback for unknown status
                                statusClass = 'bg-gray-200 text-gray-800';
                            }

                            // Only Finalizada or Completada sales can be cancelled
                            const canBeCancelled = venta.estatus === 'F' || venta.estatus === 'C';
                            
                            row.innerHTML = `
                                <td>${venta.idVenta}</td>
                                <td>$${venta.montoTotal.toFixed(2)}</td>
                                <td>${venta.metodoPago}</td>
                                <td>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                        ${statusText}
                                    </span>
                                </td>
                                <td>${new Date(venta.fechaVenta).toLocaleTimeString()}</td>
                                <td class="text-center">
                                    <button 
                                        class="btn-cancelar-venta p-1 rounded-full hover:bg-danger-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-danger disabled:opacity-50 disabled:cursor-not-allowed" 
                                        data-id="${venta.idVenta}" 
                                        title="Cancelar Venta"
                                        ${canBeCancelled ? '' : 'disabled'}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-danger" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </td>
                            `;
                            historialVentasBody.appendChild(row);
                        });
                    } else {
                        historialVentasBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No se encontraron ventas para hoy.</td></tr>';
                    }
                } catch (error) {
                    historialVentasBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-red-500">Error al cargar el historial: ${error.message}</td></tr>`;
                    alertUser(`Error al cargar el historial: ${error.message}`, 'error');
                }
            }

            async function handleCancelarVenta(event) {
                const button = event.target.closest('.btn-cancelar-venta');
                if (button) {
                    const ventaId = button.dataset.id;
                    if (confirm(`¿Está seguro de que desea cancelar la venta #${ventaId}? Esta acción no se puede deshacer.`)) {
                        try {
                            await fetchApi(`/ventas/cancelarVenta/${ventaId}`, 'PUT');
                            alertUser(`Venta #${ventaId} cancelada correctamente.`, 'success');
                            await cargarHistorialVentas(); // Recargar la lista
                        } catch (error) {
                            console.error('Error al cancelar venta:', error);
                            alertUser(`Error al cancelar la venta: ${error.message}`, 'error');
                        }
                    }
                }
            }

            async function removeProductFromTicket(index) {
                const itemToRemove = ticket[index];
                try {
                    await fetchApi(`/ventasDetalle/eliminarVentaDetalle/${itemToRemove.idVentaDetalle}`, 'DELETE');
                    ticket.splice(index, 1); // Remove from local array
                    renderTicket(); // Re-render the table
                    alertUser(`Producto "${itemToRemove.nombreProducto}" eliminado del ticket.`, 'success');
                } catch (error) {
                    alertUser(`Error al eliminar producto: ${error.message}`, 'error');
                }
            }


            verHistorialBtn.addEventListener('click', () => {
                historialModal.classList.remove('hidden');
                cargarHistorialVentas();
            });

            cerrarHistorialModalBtn.addEventListener('click', () => {
                historialModal.classList.add('hidden');
            });
            
            historialModal.addEventListener('click', (event) => {
                if (event.target === historialModal) {
                    historialModal.classList.add('hidden');
                }
            });

            async function addGramajeProductToSale() {
                const productId = calcProductId.value;
                const productName = calcProductName.value;
                let grams = parseFloat(gramajeInput.value); // New ID
                let totalPrice = parseFloat(precioTotal.value); // Read from .value now

                const pricePerKiloFromProduct = parseFloat(calcProductPricePerKilo.value); // Hidden original price_venta from product
                const stockAvailable = parseFloat(calcProductStock.value); // Stock is also in grams for gramaje products
                const currentPricePerKilo = parseFloat(precioBase.value); // Current visible price per kilo from input

                if (isNaN(grams) || grams <= 0 || isNaN(totalPrice) || totalPrice <= 0) {
                    alertUser('Por favor, ingrese un gramaje o precio total válido.', 'error');
                    return;
                }
                
                // Ensure grams is a whole number if that's the intention, or adjust precision
                grams = Math.round(grams); 
                totalPrice = parseFloat(totalPrice.toFixed(2)); // Ensure consistent precision

                if (grams > stockAvailable) {
                    alertUser(`Stock insuficiente para "${productName}". Disponible: ${stockAvailable} gramos.`, 'error');
                    return;
                }

                try {
                    if (!activeSaleId) {
                        await createNewSale();
                    }

                    if (!activeSaleId) throw new Error("No se pudo crear una nueva venta.");

                    const existingItemIndex = ticket.findIndex(item => item.idProducto === productId);

                    // For gramaje products, if already in ticket, we treat it as a new line item
                    // or ask the user if they want to add to existing. For simplicity, let's add as new.
                    // If the user wants to combine, they can do it manually after.
                    // OR, if the requirement is to always add to existing if same product:
                    if (existingItemIndex !== -1) {
                        const existingItem = ticket[existingItemIndex];
                        const newTotalGrams = existingItem.cantidad + grams; // Assuming cantidad for gramaje product is in grams

                        if (newTotalGrams > stockAvailable) {
                            alertUser(`Stock insuficiente para "${productName}". Al intentar agregar ${grams}g, excedería el stock total. Disponible: ${stockAvailable} gramos.`, 'error');
                            return;
                        }

                        // Update existing item
                        const updatedItem = {
                            ...existingItem,
                            cantidad: newTotalGrams,
                            // Use the currentPricePerKilo from the modal for calculation, not the average
                            precioUnitarioVenta: totalPrice / grams, // This is price per gram based on current modal calculation
                        };
                        await fetchApi(`/ventasDetalle/actualizarVentaDetalle/${existingItem.idVentaDetalle}`, 'PUT', {
                            cantidad: updatedItem.cantidad,
                            precioUnitarioVenta: updatedItem.precioUnitarioVenta,
                        });
                        ticket[existingItemIndex] = updatedItem;
                    } else {
                        // Add as new item
                        const productData = {
                            idProducto: productId,
                            nombre: productName,
                            precio_venta: currentPricePerKilo, // Use the current price per kilo from modal
                            stock: stockAvailable,
                            is_gramaje: true
                        };
                        const ventaData = await fetchApi(`/ventas/obtenerVentaPorId/${activeSaleId}`);
                        const detailPayload = {
                            cantidad: grams, // Quantity is in grams
                            precioUnitarioVenta: totalPrice / grams, // Price per gram
                            Venta: ventaData,
                            Producto: productData,
                            tipoPrecioAplicado: "VENTA_GRAMAJE" // New type for gramaje sales
                        };
                        const newDetail = await fetchApi('/ventasDetalle/agregarVentaDetalle', 'POST', detailPayload);
                        ticket.push({
                            idProducto: productId,
                            nombreProducto: productName,
                            cantidad: grams,
                            precioUnitarioVenta: totalPrice / grams,
                            existence: stockAvailable,
                            idVentaDetalle: newDetail.idVentaDetalle,
                            Venta: ventaData,
                            Producto: productData,
                            isMayoreo: false // Gramaje products typically don't have mayoreo in the same way
                        });
                    }

                    renderTicket();
                    closeGramajeCalculator();
                    alertUser(`Producto por gramaje "${productName}" agregado a la venta.`, 'success');

                } catch (error) {
                    alertUser(`Error al agregar producto por gramaje: ${error.message}`, 'error');
                } finally {
                    codigoProductoInput.value = '';
                    codigoProductoInput.disabled = false;
                    agregarProductoBtn.textContent = 'ENTER - Agregar por Código';
                    codigoProductoInput.focus();
                }
            }

            // Gramaje Calculator Event Listeners
            gramajeInput.addEventListener('input', () => updateCalculatorDisplay('grams'));
            precioTotal.addEventListener('input', () => updateCalculatorDisplay('totalPrice'));
            precioBase.addEventListener('input', () => updateCalculatorDisplay('grams')); // Changing priceBase affects total price which is derived from grams

            calcCancelBtn.addEventListener('click', closeGramajeCalculator);
            calcAddToCartBtn.addEventListener('click', addGramajeProductToSale);
            calcResetBtn.addEventListener('click', resetGramajeCalculator); // Reset button event listener

            // Event listeners for quick action buttons
            document.querySelectorAll('[data-gramaje]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const grams = parseFloat(e.target.dataset.gramaje);
                    if (!isNaN(grams)) {
                        setGramaje(grams);
                    }
                });
            });
            initializeSale(); // Call initializeSale here after everything is set up
        }); // Correctly closing DOMContentLoaded
    } // Correctly closing if (activeUser)
</script>
    <script src="nav.js" defer></script>

    <!-- Modal para Calculadora de Gramaje -->
    <div id="gramajeCalculatorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center z-50">
                    <div class="relative p-5 border w-11/12 md:max-w-3xl shadow-lg rounded-md bg-white text-center">
                        <h3 class="text-lg leading-6 font-medium text-primary mb-4">Calculadora de Gramaje</h3>
                        <div class="mb-3">
                            <label for="calcProductName" class="block text-sm font-medium text-gray-700">Producto:</label>
                            <input type="text" id="calcProductName" class="config-input" readonly>
                            <input type="hidden" id="calcProductId">
                            <input type="hidden" id="calcProductPricePerKilo"> <!-- This will be the original price_venta from product, used in calculations -->
                            <input type="hidden" id="calcProductStock">
                        </div>
                        
                        <div class="grid-table">
                            <!-- Fila 1: Títulos -->
                            <div class="calc-header-text">Gramaje a vender (g)</div>
                            <div class="calc-header-text">Precio Total ($)</div>
        
                            <!-- Fila 2: Inputs/Valores -->
                            <div>
                                <input type="number" id="gramajeInput" class="big-number input-focus" value="" step="10" placeholder="0">
                            </div>
                            <div>
                                <input type="number" id="precioTotal" class="big-number text-profit-color" value="0.00" step="0.01" placeholder="0">
                            </div>
                        </div>
        
                        <div class="controls">
                            <div>
                                <label class="label">Precio por Kilogramo (1000g)</label>
                                <input type="number" id="precioBase" class="config-input" value="" step="0.5">
                            </div>
                            <div>
                                <label class="label">Acciones rápidas</label>
                                <div class="flex gap-2">
                                    <button type="button" class="bg-gray-200 px-4 py-2 rounded-lg font-bold" data-gramaje="250">250g</button>
                                    <button type="button" class="bg-gray-200 px-4 py-2 rounded-lg font-bold" data-gramaje="500">500g</button>
                                    <button type="button" class="bg-gray-200 px-4 py-2 rounded-lg font-bold" data-gramaje="1000">1kg</button>
                                </div>
                            </div>
                            
                            <button type="button" id="calcResetBtn" class="calc-btn-reset">Limpiar Campos</button>
                        </div>
                        <div class="flex justify-around items-center space-x-2 mt-4">
                            <button id="calcAddToCartBtn" class="w-full btn-primary text-white font-semibold py-2 rounded-lg hover:bg-primary-dark transition duration-150 shadow-md">
                                Agregar a Venta
                            </button>
                            <button id="calcCancelBtn" class="w-full btn-secondary text-white font-semibold py-2 rounded-lg hover:bg-secondary-dark transition duration-150 shadow-md">
                                Cancelar
                            </button>
                        </div>
                    </div>    </div>
</body>

</html>