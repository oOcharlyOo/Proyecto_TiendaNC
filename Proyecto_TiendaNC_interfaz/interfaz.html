<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Punto de Venta - VENTA</title>
    <link rel="stylesheet" href="resources/style/output.css">
    <link rel="stylesheet" href="resources/style/estilos.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- QuaggaJS para lectura de códigos de barras -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 0.75rem;
            background: #000;
        }
        #interactive.viewport video, #interactive.viewport canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        /* Línea guía del escáner */
        .scanner-laser {
            position: absolute;
            top: 50%;
            left: 10%;
            width: 80%;
            height: 2px;
            background: rgba(255, 0, 0, 0.5);
            box-shadow: 0 0 10px 2px rgba(255, 0, 0, 0.7);
            z-index: 10;
            transform: translateY(-50%);
            animation: scan 2s infinite;
        }
        @keyframes scan {
            0%, 100% { top: 30%; }
            50% { top: 70%; }
        }
    </style>
</head>

<body class="main-page-body">
    <div id="navbar-placeholder"></div>

    <div class="main-container flex flex-col md:flex-row w-full max-w-7xl mx-auto mt-16 p-2 gap-4">
        <div class="flex-grow flex flex-col">
            <!-- Sección del Escáner -->
            <div id="scanner-container" class="bg-white p-2 rounded-2xl shadow-lg mb-6 hidden">
                <div id="interactive" class="viewport">
                    <div class="scanner-laser"></div>
                </div>
                <button id="stopScannerBtn" class="w-full mt-2 py-2 text-red-600 font-medium text-sm">
                    Cancelar Escaneo
                </button>
            </div>

             <!-- Feedback de Último Escaneo -->
             <div id="scan-feedback" class="hidden mb-6 p-4 bg-green-100 text-green-800 rounded-xl border border-green-200 flex items-center gap-3">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                <div>
                    <p class="font-bold">Código Detectado</p>
                    <p id="detected-id" class="text-sm opacity-90"></p>
                </div>
            </div>

            <div id="ticketPanel" class="flex-grow flex flex-col rounded-lg shadow-xl overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800" style="color: var(--ticket-header-color);">VENTA - Ticket <span id="ticketIdDisplay">Cargando...</span>
                    </h2>
                    <div class="flex flex-col sm:flex-row mt-3 space-y-2 sm:space-y-0 sm:space-x-2">
                        <div class="relative flex-grow">
                            <label for="codigoProducto" class="block text-sm font-medium text-primary self-center" style="color: var(--neutral-800);">Código o Nombre del Producto:</label>
                            <input type="text" id="codigoProducto" placeholder="Escanear código o escribir nombre..."
                                class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary input-focus-primary"
                                disabled>
                            <div id="searchResultsContainer" class="absolute z-10 w-full border border-gray-300 rounded-b-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto">
                                <!-- Los resultados de la búsqueda se inyectarán aquí -->
                            </div>  
                        </div>
                        <button id="agregarProductoBtn"
                            class="btn-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-dark transition duration-150 shadow-md self-end"
                            disabled>ENTER - Agregar por Código</button>
                        <button id="startScannerBtn" class="flex items-center justify-center gap-3 bg-blue-600 text-white p-2 rounded-lg shadow-md hover:bg-blue-700 transition self-end">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="flex-grow flex flex-col overflow-hidden">
                    <div id="tablaEditada" class="flex-grow overflow-y-auto border-t border-gray-300">
                        <!-- Encabezado de la tabla para escritorio -->
                        <div class="hidden md:grid grid-cols-12 gap-x-4 p-3 bg-gray-100 font-semibold text-sm text-gray-700 sticky top-0 z-10">
                            <div class="col-span-2">Código</div>
                            <div class="col-span-3">Descripción</div>
                            <div class="col-span-2 text-right">P. Unit</div>
                            <div class="col-span-1 text-center">Mayoreo</div>
                            <div class="col-span-2 text-center">Cantidad</div>
                            <div class="col-span-1 text-right">Importe</div>
                            <div class="col-span-1 text-center">Acción</div>
                        </div>
                        <!-- Cuerpo de la lista de productos del ticket -->
                        <div id="ticketItems" class="divide-y divide-gray-200">
                            <!-- Los productos del ticket se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="w-full md:w-1/4 min-w-[280px] flex flex-col panel-transparent rounded-lg shadow-xl p-4">            
            <h3 class="text-lg font-bold text-gray-800 mb-4">Resumen de Venta</h3>
            <div class="flex-grow">
                <div class="summary-row flex justify-between items-center text-gray-700 text-lg"><span>Subtotal:</span><span id="subtotalDisplay">$0.00</span></div>
                <div class="summary-total mt-4 pt-4 border-t-2 border-gray-200 flex justify-between items-center text-xl font-bold"><span>TOTAL:</span><span id="totalDisplay"
                        class="text-primary">$0.00</span></div>
            </div>
            <div class="mt-4 space-y-3">
                <button id="abrirModalEntradaBtn"
                    class="w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    <span>Entrada de Efectivo</span>
                </button>
                <button id="abrirModalSalidaBtn"
                    class="w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition duration-150 shadow-md flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" />
                    </svg>
                    <span>Salida de Efectivo</span>
                </button>
                <button id="cobrarEfectivoBtn"
                    class="w-full btn-primary text-white font-semibold py-3 rounded-lg hover:bg-primary-dark transition duration-150 shadow-md">F12
                    - Cobrar (Efectivo)
                </button>
                <button id="verHistorialBtn"
                    class="w-full btn-primary text-white font-semibold py-3 rounded-lg hover:bg-primary-dark transition duration-150 shadow-md">
                    Historial de Ventas
                </button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden" hidden>
        <div class="relative p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Cobro en Efectivo</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Total a Pagar:</p>
                    <p id="modalTotalAmount" class="text-3xl font-bold text-primary">$0.00</p>
                    <div class="mt-4">
                        <label for="amountPaid" class="block text-sm font-medium text-gray-700">Monto Recibido</label>
                        <input type="number" id="amountPaid"
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
                            placeholder="0.00">
                    </div>
                    <div class="mt-4">
                        <p class="text-sm text-gray-500">Cambio:</p>
                        <p id="changeAmount" class="text-2xl font-bold text-income-color">$0.00</p>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmPaymentBtn"
                        class="px-4 py-2 btn-primary text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary">
                        Confirmar Pago
                    </button>
                    <button id="confirmPaymentSpeiBtn"
                        class="mt-2 px-4 py-2 btn-primary text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary">
                        Confirmar Pago Transferencia
                    </button>
                    <button id="cancelPaymentBtn"
                        class="mt-2 px-4 py-2 btn-danger text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-danger-dark focus:outline-none focus:ring-2 focus:ring-danger">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Historial de Ventas -->
    <div id="historialVentasModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden" hidden>
        <div class="historial-modal-content relative">
            <h3 class="text-xl leading-6 font-bold text-gray-900 mb-4">Historial de Ventas del Día</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-left">
                <div class="bg-gray-100 p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Cobro Total del Día</p>
                    <p id="historialCobroTotal" class="text-2xl font-bold text-income-color">$0.00</p>
                </div>
                <div class="bg-gray-100 p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Ganancia Total del Día</p>
                    <p id="historialGananciaTotal" class="text-2xl font-bold text-profit-color">$0.00</p>
                </div>
            </div>

            <div class="max-h-96 overflow-y-auto w-full">
                <!-- Encabezado de la tabla para escritorio -->
                <div class="hidden md:grid grid-cols-6 gap-x-4 p-3 bg-gray-100 font-semibold text-sm text-gray-700 sticky top-0 z-10">
                    <div class="col-span-1 text-center">Ticket #</div>
                    <div class="col-span-1 text-center">Monto</div>
                    <div class="col-span-1 text-center">Método Pago</div>
                    <div class="col-span-1 text-center">Estatus</div>
                    <div class="col-span-1 text-center">Fecha</div>
                    <div class="col-span-1 text-center">Acción</div>
                </div>
                <!-- Cuerpo de la lista de historial de ventas -->
                <div id="historialVentasBody" class="divide-y divide-gray-200">
                    <!-- Las ventas se cargarán aquí -->
                </div>
            </div>

            <div class="mt-6 text-right">
                <button id="cerrarHistorialModalBtn" class="btn-secondary text-white px-4 py-2 rounded-md hover:bg-secondary-dark">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Entrada de Efectivo -->
    <div id="cashInModal" class="fixed inset-0 bg-green-500 bg-opacity-50 flex items-center justify-center w-full z-50 hidden" hidden>
        <div class="relative p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Registrar Entrada de Efectivo</h3>
                <form id="cashInForm" class="mt-2 px-7 py-3">
                    <div class="mb-4">
                        <label for="cashInAmount" class="block text-sm font-medium text-gray-700 text-left">Monto:</label>
                        <input type="number" id="cashInAmount" name="montoEoS"
                            class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
                            placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="mb-4">
                        <label for="cashInDescription" class="block text-sm font-medium text-gray-700 text-left">Descripción:</label>
                        <textarea id="cashInDescription" name="descripcion" rows="3"
                            class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
                            placeholder="Motivo de la entrada de efectivo"></textarea>
                    </div>
                    <!-- Assuming idUsuario and montoInicial will be handled by JS or backend -->
                    <input type="hidden" id="cashInUserId" name="idUsuario" value="1"> 
                    <div class="items-center px-4 py-3">
                        <button type="submit"
                            class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                            Registrar Entrada
                        </button>
                        <button type="button" id="cancelCashInBtn"
                            class="mt-2 px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Salida de Efectivo -->
    <div id="cashOutModal" class="fixed inset-0 bg-red-500 bg-opacity-50 flex items-center justify-center w-full z-50 hidden" hidden>
        <div class="relative p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Registrar Salida de Efectivo</h3>
                <form id="cashOutForm" class="mt-2 px-7 py-3">
                    <div class="mb-4">
                        <label for="cashOutAmount" class="block text-sm font-medium text-gray-700 text-left">Monto:</label>
                        <input type="number" id="cashOutAmount" name="montoEoS"
                            class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm"
                            placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="mb-4">
                        <label for="cashOutDescription" class="block text-sm font-medium text-gray-700 text-left">Descripción:</label>
                        <textarea id="cashOutDescription" name="descripcion" rows="3"
                            class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm"
                            placeholder="Motivo de la salida de efectivo"></textarea>
                    </div>
                    <!-- Assuming idUsuario and montoInicial will be handled by JS or backend -->
                    <input type="hidden" id="cashOutUserId" name="idUsuario" value="1">
                    <div class="items-center px-4 py-3">
                        <button type="submit"
                            class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                            Registrar Salida
                        </button>
                        <button type="button" id="cancelCashOutBtn"
                            class="mt-2 px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="resources/js/interfaz.js" defer></script>
    <script src="nav.js" defer></script>

    <!-- Modal para Calculadora de Gramaje -->
    <div id="gramajeCalculatorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden" hidden>
                    <div class="relative p-5 border w-11/12 md:max-w-3xl shadow-lg rounded-md bg-white text-center">
                        <h3 class="text-lg leading-6 font-medium text-primary mb-4">Calculadora de Gramaje</h3>
                        <div class="mb-3">
                            <label for="calcProductName" class="block text-sm font-medium text-gray-700">Producto:</label>
                            <input type="text" id="calcProductName" class="config-input" readonly>
                            <input type="hidden" id="calcProductId">
                            <input type="hidden" id="calcProductPricePerKilo"> <!-- This will be the original price_venta from product, used in calculations -->
                            <input type="hidden" id="calcProductStock">
                        </div>
                        
                        <div class="grid-table">
                            <!-- Fila 1: Títulos -->
                            <div class="calc-header-text">Gramaje a vender (g)</div>
                            <div class="calc-header-text">Precio Total ($)</div>
        
                            <!-- Fila 2: Inputs/Valores -->
                            <div>
                                <input type="number" id="gramajeInput" class="big-number input-focus" value="" step="10" placeholder="0">
                            </div>
                            <div>
                                <input type="number" id="precioTotal" class="big-number text-profit-color" value="0.00" step="0.01" placeholder="0">
                            </div>
                        </div>
        
                        <div class="controls">
                            <div>
                                <label class="label">Precio por Kilogramo (1000g)</label>
                                <input type="number" id="precioBase" class="config-input" value="" step="0.5">
                            </div>
                            <div>
                                <label class="label">Acciones rápidas</label>
                                <div class="flex gap-2">
                                    <button type="button" class="bg-gray-200 px-4 py-2 rounded-lg font-bold" data-gramaje="250">250g</button>
                                    <button type="button" class="bg-gray-200 px-4 py-2 rounded-lg font-bold" data-gramaje="500">500g</button>
                                    <button type="button" class="bg-gray-200 px-4 py-2 rounded-lg font-bold" data-gramaje="1000">1kg</button>
                                </div>
                            </div>
                            
                            <button type="button" id="calcResetBtn" class="calc-btn-reset">Limpiar Campos</button>
                        </div>
                        <div class="flex justify-around items-center space-x-2 mt-4">
                            <button id="calcAddToCartBtn" class="w-full btn-primary text-white font-semibold py-2 rounded-lg hover:bg-primary-dark transition duration-150 shadow-md">
                                Agregar a Venta
                            </button>
                            <button id="calcCancelBtn" class="w-full btn-secondary text-white font-semibold py-2 rounded-lg hover:bg-secondary-dark transition duration-150 shadow-md">
                                Cancelar
                            </button>
                        </div>
                    </div>
    </div>

    <!-- Generic Alert Modal -->
    <div id="alertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 hidden" hidden>
        <div class="relative p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="alertModalTitle" class="text-lg leading-6 font-medium text-gray-900"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="alertModalMessage" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="alertModalCloseBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL para Detalle de Venta -->
    <div id="saleDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center hidden" hidden>
        <div class="relative p-4 sm:p-5 border w-full max-w-xl md:max-w-2xl shadow-lg rounded-md bg-white max-h-full overflow-y-auto">
            <h3 id="saleDetailsModalTitle" class="text-xl leading-6 font-bold text-gray-900 mb-4">Detalles de Venta #<span id="detailNumeroTicket"></span></h3>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4 text-sm">
                <div><span class="font-semibold">ID Venta:</span> <span id="detailIdVenta"></span></div>
                <div><span class="font-semibold">Monto Total:</span> <span id="detailMontoTotal"></span></div>
                <div><span class="font-semibold">Método de Pago:</span> <span id="detailMetodoPago"></span></div>
                <div><span class="font-semibold">Estatus:</span> <span id="detailEstatus"></span></div>
                <div><span class="font-semibold">Fecha:</span> <span id="detailFechaVenta"></span></div>
            </div>

            <h4 class="text-lg font-bold text-gray-800 mb-2">Productos en la Venta</h4>
            <div class="max-h-60 overflow-y-auto">
                <table class="w-full text-left ticket-table text-sm">
                    <thead>
                        <tr>
                            <th class="p-2 text-center">Código</th>
                            <th class="p-2 text-center">Descripción</th>
                            <th class="p-2 text-center">Cantidad</th>
                            <th class="p-2 text-center">Precio Unitario</th>
                            <th class="p-2 text-center">Importe</th>
                        </tr>
                    </thead>
                    <tbody id="saleDetailsTableBody">
                        <!-- Detalles de productos se insertarán aquí -->
                    </tbody>
                </table>
            </div>

            <div class="mt-6 text-right">
                <button id="closeSaleDetailsModalBtn" class="btn-secondary text-white px-4 py-2 rounded-md hover:bg-secondary-dark">
                    Cerrar
                </button>
            </div>
        </div>
    </div>