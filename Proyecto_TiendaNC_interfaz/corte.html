<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Punto de Venta - CORTE DE CAJA</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir Chart.js para la gráfica -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="resources/style/estilos.css">
</head>
<body class="main-page-body">
    
    <!-- BARRA SUPERIOR DE NAVEGACIÓN -->
    <div id="navbar-placeholder"></div>

    <div class="main-container" style="height: max-content;">
        <div class="items-center justify-center w-full panel-transparent rounded-lg shadow-2xl p-4 sm:p-6 md:p-8 space-y-4 sm:space-y-6 md:space-y-8 z-50">
            <header class="border-b pb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Corte de Caja</h1>
                <p class="text-sm sm:text-base text-gray-600 mt-1">Genera y visualiza el reporte de tu corte de caja o consulta reportes de días anteriores.</p>
            </header>

            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-4 sm:mb-8 justify-center">
                <button id="generateCorteBtn" class="btn-primary text-white font-semibold py-2 px-6 sm:py-3 sm:px-8 rounded-lg transition duration-150 shadow-md text-base sm:text-lg">
                    Generar Corte de Caja
                </button>
                <button id="generateDailyReportBtn" class="btn-primary text-white font-semibold py-2 px-6 sm:py-3 sm:px-8 rounded-lg transition duration-150 shadow-md text-base sm:text-lg hidden">
                    Generar Reporte por Día
                </button>
            </div>

            <section id="corteReporte" class="hidden">
                <h2 id="reportTitle" class="text-lg sm:text-xl font-semibold text-gray-700 mb-3 sm:mb-4">Reporte del Corte</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                    <div class="summary-card income-card p-4 sm:p-6">
                        <p class="summary-title text-xs sm:text-sm whitespace-normal break-words">Fecha del Reporte</p>
                        <p id="reporteFechaCorte" class="summary-value text-xl sm:text-2xl text-gray-800 whitespace-normal break-words"></p>
                    </div>
                    <div class="summary-card income-card p-4 sm:p-6">
                        <p class="summary-title text-xs sm:text-sm whitespace-normal break-words">Cajero</p>
                        <p id="reporteCajero" class="summary-value text-xl sm:text-2xl text-gray-800 whitespace-normal break-words"></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 mt-4 sm:mt-6">
                    <div class="summary-card p-4 sm:p-6">
                        <p class="summary-title text-xs sm:text-sm text-income-color whitespace-normal break-words">Monto Inicial</p>
                        <p id="reporteMontoInicial" class="summary-value text-xl sm:text-2xl income-value whitespace-normal break-words"></p>
                    </div>
                    <!-- New card for Ventas en Efectivo -->
                    <div class="summary-card p-4 sm:p-6">
                        <p class="summary-title text-xs sm:text-sm text-income-color whitespace-normal break-words">Ventas en Efectivo</p>
                        <p id="reporteVentasEfectivo" class="summary-value text-xl sm:text-2xl income-value whitespace-normal break-words"></p>
                    </div>
                    <!-- Ventas por Transferencia (formerly Otros Ingresos) -->
                    <div class="summary-card p-4 sm:p-6">
                        <p class="summary-title text-xs sm:text-sm text-profit-color whitespace-normal break-words">Ventas por Transferencia</p>
                        <p id="reporteOtrosIngresos" class="summary-value text-xl sm:text-2xl income-value whitespace-normal break-words"></p>
                    </div>
                    <!-- Tickets del Día -->
                    <div class="summary-card p-4 sm:p-6">
                        <p class="summary-title text-xs sm:text-sm text-cash-flow-color whitespace-normal break-words">Tickets del Día</p>
                        <p id="reporteTotalTicketsDia" class="summary-value text-xl sm:text-2xl whitespace-normal break-words">0</p>
                    </div>
                    <!-- Total Ventas (SPANS 2 COLUMNS) -->
                    <div class="summary-card p-4 sm:p-6 md:col-span-2">
                        <p class="summary-title text-xs sm:text-sm text-income-color whitespace-normal break-words">Total Ventas</p>
                        <p id="reporteTotalVentas" class="summary-value text-xl sm:text-2xl income-value whitespace-normal break-words"></p>
                    </div>
                    <!-- Total Egresos -->
                    <div class="summary-card p-4 sm:p-6">
                        <p class="summary-title text-xs sm:text-sm text-danger whitespace-normal break-words">Total Egresos</p>
                        <p id="reporteTotalEgresos" class="summary-value text-xl sm:text-2xl expense-value whitespace-normal break-words"></p>
                    </div>
                    <!-- Ganancia Total -->
                    <div class="summary-card profit-card p-4 sm:p-6">
                        <p class="summary-title text-xs sm:text-sm text-profit-color whitespace-normal break-words">Ganancia Total</p>
                        <p id="reporteGananciaTotal" class="summary-value text-xl sm:text-2xl profit-value whitespace-normal break-words"></p>
                        <p class="text-xs text-gray-500 mt-1">Beneficio total del corte</p>
                    </div>
                </div>

                <div class="summary-card cash-flow-card mt-4 sm:mt-6 p-4 sm:p-6">
                    <p class="summary-title text-sm sm:text-base text-profit-color whitespace-normal break-words">SALDO FINAL CALCULADO</p>
                    <p id="reporteSaldoFinalCalculado" class="summary-value text-3xl sm:text-4xl cash-flow-value whitespace-normal break-words"></p>
                </div>
                
                <!-- GRÁFICA PIE CHART AGREGADA AQUÍ -->
                <div class="mt-6 sm:mt-8">
                    <h3 id="chartTitle" class="text-lg sm:text-xl font-semibold text-gray-700 mb-3 sm:mb-4 border-t pt-3 sm:pt-4">Composición del Flujo de Efectivo Bruto (Entradas)</h3>
                    <div class="panel-transparent p-4 sm:p-6 rounded-xl shadow-lg flex justify-center items-center min-h-0">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>
                <!-- FIN GRÁFICA -->
                
                <div class="flex justify-center pt-6 sm:pt-8">
                    <button id="cerrarTurnoBtn" class="btn-primary text-white font-semibold py-2 px-8 sm:py-3 sm:px-12 rounded-lg transition duration-150 shadow-xl text-base sm:text-lg">
                        Cerrar Turno
                    </button>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal para seleccionar fecha de reporte diario -->
    <div id="dailyReportModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Generar Reporte por Día</h3>
                <div class="mt-4 px-7 py-3">
                    <label for="reportDate" class="block text-sm font-medium text-gray-700 text-left">Selecciona una fecha:</label>
                    <input type="date" id="reportDate" name="reportDate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                <div class="items-center px-4 py-3 space-x-4">
                    <button id="generateReportFromModalBtn" class="px-4 py-2 btn-primary text-white text-base font-medium rounded-md shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary">
                        Generar Reporte
                    </button>
                    <button id="cancelModalBtn" class="px-4 py-2 btn-secondary text-white text-base font-medium rounded-md shadow-sm hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-secondary">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURACIÓN Y UTILIDADES ---
        const API_BASE_URL = 'http://192.168.0.248:8080';
        
        const activeUser = JSON.parse(sessionStorage.getItem('activeUser')) || { idUsuario: 1, nombre: 'Usuario Desconocido' };
        const ID_USUARIO = activeUser.idUsuario;
        let currentCorteDTO = null;

        const generateCorteBtn = document.getElementById('generateCorteBtn');
        const generateDailyReportBtn = document.getElementById('generateDailyReportBtn');
        const cerrarTurnoBtn = document.getElementById('cerrarTurnoBtn');
        const corteReporte = document.getElementById('corteReporte');

        // Nuevos elementos de la modal
        const dailyReportModal = document.getElementById('dailyReportModal');
        const generateReportFromModalBtn = document.getElementById('generateReportFromModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const reportDateInput = document.getElementById('reportDate');

        // Elementos del reporte
        const reportTitle = document.getElementById('reportTitle');
        const chartTitle = document.getElementById('chartTitle');
        const reporteFechaCorte = document.getElementById('reporteFechaCorte');
        const reporteCajero = document.getElementById('reporteCajero');
        const reporteMontoInicial = document.getElementById('reporteMontoInicial');
        const reporteVentasEfectivo = document.getElementById('reporteVentasEfectivo'); // Nuevo elemento
        const reporteTotalVentas = document.getElementById('reporteTotalVentas');
        const reporteOtrosIngresos = document.getElementById('reporteOtrosIngresos');
        const reporteTotalEgresos = document.getElementById('reporteTotalEgresos');
        const reporteSaldoFinalCalculado = document.getElementById('reporteSaldoFinalCalculado');
        const reporteGananciaTotal = document.getElementById('reporteGananciaTotal');

        const formatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 });
        function formatCurrency(amount) { return formatter.format(amount || 0); }

        function alertUser(message, type = 'info') {
            let existingAlert = document.getElementById('tempAlert');
            if (existingAlert) existingAlert.remove();
            const alertDiv = document.createElement('div');
            alertDiv.id = 'tempAlert';
            alertDiv.textContent = message;
            alertDiv.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition-all duration-300 transform`;
            
            if (type === 'success') {
                alertDiv.classList.add('bg-green-500');
            } else if (type === 'error') {
                alertDiv.classList.add('bg-danger');
            } else {
                alertDiv.classList.add('bg-blue-500');
            }
            
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }

        async function fetchApi(endpoint, method = 'GET', data = null) {
            let url = `${API_BASE_URL}${endpoint}`;
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (data) options.body = JSON.stringify(data);
            console.log(`[API Call] ${method} ${url}`, data);
            try {
                const response = await fetch(url, options);
                let responseText = null;
                if (response.status !== 204) {
                    responseText = await response.text();
                }
                let responseData;
                const contentType = response.headers.get("content-type");
                if (responseText !== null && contentType && contentType.includes("application/json")) {
                    try { responseData = JSON.parse(responseText); } catch (e) {
                        responseData = responseText;
                        console.warn(`API response claimed JSON but failed to parse for ${url}:`, e);
                    }
                } else {
                    responseData = responseText;
                }
                if (!response.ok) {
                    const errorDetail = (responseData && (responseData.mensaje || responseData.error || responseData.message))
                                        ? (typeof responseData === 'object' ? JSON.stringify(responseData) : responseData)
                                        : `Error HTTP: ${response.status} ${response.statusText}`;
                    throw new Error(`API Error: ${errorDetail}`);
                }
                return (typeof responseData === 'object' && responseData !== null && responseData.hasOwnProperty('datos') && responseData.datos !== null) ? responseData.datos : responseData;
            } catch (error) {
                console.error("Error en la llamada a la API:", error);
                throw error;
            }
        }
        
        let cashFlowChartInstance = null;

        function drawCashFlowChart(reportData, isHistoric = false) {
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            if (cashFlowChartInstance) {
                cashFlowChartInstance.destroy();
            }

            let labels, dataValues, titleText, totalBruto;

            if (isHistoric) { // Reporte Histórico por Día
                const ventasEfectivo = reportData.ventas.filter(v => v.metodoPago === 'EFECTIVO').reduce((sum, v) => sum + v.montoTotal, 0);
                const ventasTransferencia = reportData.ventas.filter(v => v.metodoPago === 'TRANSFERENCIA').reduce((sum, v) => sum + v.montoTotal, 0);
                
                labels = ['Ventas en Efectivo', 'Ventas por Transferencia'];
                dataValues = [ventasEfectivo, ventasTransferencia];
                totalBruto = reportData.cobroTotal;
                titleText = `Ingresos Totales: ${formatCurrency(totalBruto)}`;
                chartTitle.textContent = 'Composición del Flujo de Efectivo Bruto (Entradas)';

            } else { // Lógica para el corte de caja en vivo
                labels = ['Monto Inicial', 'Ventas en Efectivo', 'Ventas por Transferencia', 'Otros Ingresos'];
                
                const montoInicial = reportData.montoInicial || 0;
                const ventasEfectivo = reportData.ventasEfectivo || 0; 
                const ventasTransferencia = reportData.ventasTransferencia || 0; 
                const otrosIngresos = reportData.otrosIngresos || 0;
                
                dataValues = [montoInicial, ventasEfectivo, ventasTransferencia, otrosIngresos];
                totalBruto = montoInicial + ventasEfectivo + ventasTransferencia + otrosIngresos;
                
                titleText = `Total Entradas: ${formatCurrency(totalBruto)}`;
                chartTitle.textContent = 'Composición del Flujo de Caja';
            }

            const chartData = {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: ['#f97316', '#10b981', '#3b82f6', '#af7810'], 
                    hoverOffset: 15
                }]
            };
            
            cashFlowChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = totalBruto > 0 ? ((value / totalBruto) * 100).toFixed(1) : "0.0";
                                            return {
                                                text: `${label}: ${formatCurrency(value)} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].backgroundColor[i],
                                                lineWidth: 1,
                                                hidden: isNaN(value) || value === 0,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: titleText,
                            font: { size: 16, weight: 'bold' },
                            padding: { bottom: 20 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = totalBruto > 0 ? ((value / totalBruto) * 100).toFixed(1) : "0.0";
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }


        function renderCorteReport(corteDTO, ventasEfectivo, ventasTransferencia, salesTodayLength) {
            // 1. Asegurar que los títulos sean los originales para el corte en vivo
            reportTitle.textContent = 'Reporte del Corte Actual';
            reporteMontoInicial.parentElement.querySelector('.summary-title').textContent = 'Monto Inicial';
            reporteVentasEfectivo.parentElement.querySelector('.summary-title').textContent = 'Ventas en Efectivo'; // Nuevo título
            reporteOtrosIngresos.parentElement.querySelector('.summary-title').textContent = 'Ventas por Transferencia'; // Cambiado
            // El título del Total Ventas se mantiene en el HTML.

            // 2. Poblar los datos del corte en vivo
            reporteFechaCorte.textContent = new Date(corteDTO.fechaCorte).toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' });
            reporteCajero.textContent = activeUser.nombre; 
            reporteMontoInicial.textContent = formatCurrency(corteDTO.montoInicial);
            reporteVentasEfectivo.textContent = formatCurrency(ventasEfectivo); // Nuevo campo
            reporteTotalVentas.textContent = formatCurrency(corteDTO.totalVentas); // Usar total del backend
            reporteOtrosIngresos.textContent = formatCurrency(ventasTransferencia); // Ventas por Transferencia
            reporteTotalEgresos.textContent = formatCurrency(corteDTO.totalEgresos);
            reporteSaldoFinalCalculado.textContent = formatCurrency(corteDTO.saldoFinalCalculado); // Usar saldo del backend
            reporteGananciaTotal.textContent = formatCurrency(corteDTO.gananciaTotal); // Usar ganancia del backend
            
            document.getElementById('reporteTotalTicketsDia').textContent = salesTodayLength;

            corteReporte.classList.remove('hidden');
            generateDailyReportBtn.classList.remove('hidden');
            cerrarTurnoBtn.classList.remove('hidden');

            currentCorteDTO = corteDTO; 

            // 3. Preparar datos para el gráfico
            const chartDataForLiveReport = {
                montoInicial: corteDTO.montoInicial,
                ventasEfectivo: ventasEfectivo,
                ventasTransferencia: ventasTransferencia,
                otrosIngresos: corteDTO.otrosIngresos // Incluir por si tiene valor
            };
            drawCashFlowChart(chartDataForLiveReport, false);
        }

        function renderHistoricReport(data, date) {
            // 1. Cambiar dinámicamente los títulos para el reporte histórico
            reportTitle.textContent = `Reporte del Día: ${date}`;
            reporteMontoInicial.parentElement.querySelector('.summary-title').textContent = 'Monto Inicial'; // Mantener el título original
            reporteVentasEfectivo.parentElement.querySelector('.summary-title').textContent = 'Ventas en Efectivo'; // Nuevo título
            reporteOtrosIngresos.parentElement.querySelector('.summary-title').textContent = 'Ventas por Transferencia'; // Cambiado
            
            // 2. Si no hay datos o la lista de ventas está vacía, muestra un reporte en ceros.
            if (!data || !data.ventas || data.ventas.length === 0) {
                alertUser(`No se encontraron datos de ventas para el día ${date}.`, 'info');
                const emptyReport = { cobroTotal: 0, gananciaTotal: 0, ventas: [] };
                
                reporteMontoInicial.textContent = formatCurrency(0); // Monto Inicial = 0 para reporte histórico
                reporteVentasEfectivo.textContent = formatCurrency(0); // Nuevo campo
                reporteOtrosIngresos.textContent = formatCurrency(0); // Ventas por Transferencia
                reporteTotalVentas.textContent = formatCurrency(0);
                reporteGananciaTotal.textContent = formatCurrency(0);
                reporteSaldoFinalCalculado.textContent = formatCurrency(0);
                document.getElementById('reporteTotalTicketsDia').textContent = 0;
                reporteTotalEgresos.textContent = formatCurrency(0);
                drawCashFlowChart(emptyReport, true);
            } else {
                // 3. Calcular ventas por método de pago
                const ventasEfectivo = data.ventas.filter(v => v.metodoPago === 'EFECTIVO').reduce((sum, v) => sum + v.montoTotal, 0);
                const ventasTransferencia = data.ventas.filter(v => v.metodoPago === 'TRANSFERENCIA').reduce((sum, v) => sum + v.montoTotal, 0);

                // 4. Poblar UI con los datos del reporte histórico
                reporteMontoInicial.textContent = formatCurrency(0); // Monto Inicial = 0 para reporte histórico
                reporteVentasEfectivo.textContent = formatCurrency(ventasEfectivo); // Nuevo campo
                reporteOtrosIngresos.textContent = formatCurrency(ventasTransferencia); // Ventas por Transferencia
                reporteTotalVentas.textContent = formatCurrency(data.cobroTotal);
                reporteGananciaTotal.textContent = formatCurrency(data.gananciaTotal);
                reporteSaldoFinalCalculado.textContent = formatCurrency(data.cobroTotal);
                document.getElementById('reporteTotalTicketsDia').textContent = data.ventas.length;
                reporteTotalEgresos.textContent = formatCurrency(0);
                
                alertUser(`Reporte para el día ${date} generado con éxito.`, 'success');
                drawCashFlowChart(data, true);
            }

            // 5. Mostrar y ocultar elementos correspondientes
            reporteFechaCorte.textContent = new Date(date + 'T00:00:00').toLocaleString('es-MX', { dateStyle: 'long' });
            reporteCajero.textContent = 'N/A';
            corteReporte.classList.remove('hidden');
            cerrarTurnoBtn.classList.add('hidden');
            generateDailyReportBtn.classList.remove('hidden');
        }
        
        async function generateCorteReport() {
            const initialCashAmount = parseFloat(sessionStorage.getItem('initialCashAmount'));
            if (isNaN(initialCashAmount) || initialCashAmount < 0) {
                alertUser('Error: Monto inicial de caja no encontrado o inválido. Por favor, inicia sesión nuevamente.', 'error');
                return;
            }
            generateCorteBtn.disabled = true;
            generateCorteBtn.textContent = 'Calculando...';
            generateDailyReportBtn.classList.add('hidden');
            cerrarTurnoBtn.classList.add('hidden');
            corteReporte.classList.add('hidden');

            try {
                const corteResponse = await fetchApi(`/caja/corte?idUsuario=${ID_USUARIO}&montoInicial=${initialCashAmount}`, 'POST');
                
                let salesToday = [];
                try {
                    const allSalesResponse = await fetchApi('/ventas/obetenerVentas');
                    const allSales = Array.isArray(allSalesResponse) ? allSalesResponse : (allSalesResponse.datos || []);
                    
                    const corteDate = new Date(corteResponse.fechaCorte + 'Z'); 
                    
                    salesToday = allSales.filter(sale => {
                        if (!sale.fechaVenta) return false;
                        const saleDate = new Date(sale.fechaVenta + 'Z'); 
                        return saleDate.getUTCFullYear() === corteDate.getUTCFullYear() &&
                               saleDate.getUTCMonth() === corteDate.getUTCMonth() &&
                               saleDate.getUTCDate() === corteDate.getUTCDate() &&
                               sale.estatus === 'C';
                    });
                } catch (salesError) {
                    console.error("Error al obtener el total de tickets del día:", salesError);
                }

                // Calcular ventas por método de pago para el desglose
                const ventasTransferencia = salesToday.filter(v => v.metodoPago === 'TRANSFERENCIA').reduce((sum, v) => sum + v.montoTotal, 0);
                const ventasEfectivo = salesToday.filter(v => v.metodoPago === 'EFECTIVO').reduce((sum, v) => sum + v.montoTotal, 0);

                renderCorteReport(corteResponse, ventasEfectivo, ventasTransferencia, salesToday.length);
                alertUser('Corte de caja generado con éxito.', 'success');
            } catch (error) {
                alertUser(`Error al generar el corte: ${error.message}`, 'error');
            } finally {
                generateCorteBtn.disabled = false;
                generateCorteBtn.textContent = 'Generar Corte de Caja';
            }
        }
        
        // --- Lógica para el reporte diario ---
        function openDailyReportModal() {
            reportDateInput.valueAsDate = new Date(); // Poner la fecha actual por defecto
            dailyReportModal.classList.remove('hidden');
        }

        function closeDailyReportModal() {
            dailyReportModal.classList.add('hidden');
        }

        async function generateDailyReportFromModal() {
            const selectedDate = reportDateInput.value;
            if (!selectedDate) {
                alertUser('Por favor, selecciona una fecha.', 'error');
                return;
            }
            
            generateReportFromModalBtn.disabled = true;
            generateReportFromModalBtn.textContent = 'Generando...';

            try {
                const dailyReportData = await fetchApi(`/ventas/obtenerVentaPorDia/${selectedDate}`, 'GET');
                renderHistoricReport(dailyReportData, selectedDate);
                closeDailyReportModal();
            } catch (error) {
                alertUser(`Error al generar el reporte diario: ${error.message}`, 'error');
            } finally {
                generateReportFromModalBtn.disabled = false;
                generateReportFromModalBtn.textContent = 'Generar Reporte';
            }
        }

        async function cerrarTurno() {
            if (!currentCorteDTO) {
                alertUser('Primero genera un reporte de corte de caja.', 'error');
                return;
            }
            cerrarTurnoBtn.disabled = true;
            cerrarTurnoBtn.textContent = 'Cerrando Turno...';
            try {
                const endOfDay = new Date(currentCorteDTO.fechaCorte + 'Z');
                const startOfDay = new Date(endOfDay);
                startOfDay.setUTCHours(0, 0, 0, 0);
                const payload = {
                    idUsuario: ID_USUARIO,
                    startDate: startOfDay.toISOString(), 
                    endDate: endOfDay.toISOString(),
                    oldStatus: 'C',
                    newStatus: 'F'  
                };
                await fetchApi('/caja/ventas/status', 'PUT', payload);
                alertUser('Turno cerrado con éxito. Cerrando sesión...', 'success');
                sessionStorage.clear();
                setTimeout(() => { window.location.href = 'Login.html'; }, 1500);
            } catch (error) {
                alertUser(`Error al cerrar el turno: ${error.message}`, 'error');
            } finally {
                cerrarTurnoBtn.disabled = false;
                cerrarTurnoBtn.textContent = 'Cerrar Turno';
            }
        }

        generateCorteBtn.addEventListener('click', generateCorteReport);
        generateDailyReportBtn.addEventListener('click', openDailyReportModal);
        cerrarTurnoBtn.addEventListener('click', cerrarTurno);
        
        // Listeners para la modal
        cancelModalBtn.addEventListener('click', closeDailyReportModal);
        generateReportFromModalBtn.addEventListener('click', generateDailyReportFromModal);
        
        document.addEventListener('DOMContentLoaded', () => {
             reporteCajero.textContent = activeUser.nombre;
             corteReporte.classList.add('hidden');
             generateDailyReportBtn.classList.add('hidden');
             cerrarTurnoBtn.classList.add('hidden');
        });
    </script>
</body>
</html>